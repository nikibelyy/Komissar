<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Admin • Клиенты — План на месяц</title>

<!-- iOS-like system font and safe area -->
<style>
  :root{
    --bg:#F6F7F9;
    --card:#FFFFFFE6;
    --glass: rgba(255,255,255,0.6);
    --muted:#8b92a6;
    --accent:#007AFF;
    --danger:#FF3B30;
    --radius:14px;
    --shadow: 0 6px 18px rgba(30,35,50,0.08);
    --glass-shadow: 0 8px 30px rgba(12,13,20,0.06);
    --maxw:460px;
    --gap:14px;
  }
  /* mobile-first */
  html,body{
    height:100%;
    margin:0;
    background: linear-gradient(180deg,#f7f8fb 0%, #eef2f7 100%);
    font-family: -apple-system, "SF Pro Text", "SF Pro Display", "Helvetica Neue", Roboto, Arial, sans-serif;
    color:#142334;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* safe area */
  .app {
    padding: env(safe-area-inset-top) 18px env(safe-area-inset-bottom);
    min-height:100vh;
    box-sizing:border-box;
    display:flex;
    justify-content:center;
    align-items:flex-start;
  }

  .frame {
    width:100%;
    max-width:var(--maxw);
    margin:24px auto;
  }

  header.topbar{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:var(--gap);
  }
  .topbar .title {
    flex:1;
  }
  .topbar h1{
    margin:0;
    font-size:18px;
    font-weight:600;
    letter-spacing:-0.2px;
  }
  .topbar p {
    margin:0;
    color:var(--muted);
    font-size:13px;
  }

  /* main panel */
  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.6));
    border-radius:var(--radius);
    box-shadow:var(--glass-shadow);
    padding:14px;
    backdrop-filter: blur(10px) saturate(110%);
  }

  .controls{
    display:flex;
    gap:10px;
    margin-bottom:10px;
  }

  button.btn{
    appearance:none;
    border:0;
    background:var(--accent);
    color:white;
    padding:10px 12px;
    border-radius:12px;
    font-weight:600;
    box-shadow: 0 6px 14px rgba(0,122,255,0.18);
    cursor:pointer;
  }
  button.btn.ghost{
    background:transparent;
    color:var(--accent);
    border:1px solid rgba(0,122,255,0.12);
    box-shadow:none;
  }
  button.btn.danger{
    background:var(--danger);
    box-shadow: 0 6px 14px rgba(255,59,48,0.18);
  }

  /* list */
  .clients{
    display:grid;
    gap:12px;
  }
  .client-card{
    background:var(--card);
    border-radius:12px;
    padding:12px;
    box-shadow:var(--shadow);
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .client-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  .client-info{
    display:flex;
    gap:10px;
    align-items:center;
  }
  .avatar{
    width:52px;
    height:52px;
    border-radius:12px;
    background:linear-gradient(135deg,#e9eefc,#fff);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    color:#2b3a67;
    box-shadow: 0 5px 12px rgba(30,35,50,0.06) inset;
  }
  .meta h3{ margin:0; font-size:16px;}
  .meta p{ margin:0; color:var(--muted); font-size:13px;}

  .card-actions{
    display:flex;
    gap:8px;
    align-items:center;
  }

  /* monthly plan */
  .plan {
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:8px;
  }
  .week {
    background:linear-gradient(180deg,#fff,#fbfbff);
    border-radius:10px;
    padding:8px;
    font-size:13px;
  }
  .week h4 { margin:0 0 6px 0; font-size:13px; color:#243347; }
  .task {
    display:flex;
    gap:8px;
    align-items:flex-start;
    margin-bottom:6px;
  }
  .task input[type="text"]{
    flex:1;
    border:1px solid #eef2f7;
    padding:8px;
    border-radius:8px;
    outline:none;
    font-size:13px;
  }
  .task button{ padding:6px 8px; border-radius:8px; background:transparent; border:none; color:var(--danger); cursor:pointer; }

  /* modal */
  .modal-backdrop{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:60;
    padding:env(safe-area-inset-top) 12px env(safe-area-inset-bottom);
    backdrop-filter: blur(6px) saturate(110%);
  }
  .modal-backdrop.show{ display:flex; }
  .modal {
    width:100%;
    max-width:420px;
    border-radius:16px;
    background:linear-gradient(180deg,#fff,#f8fbff);
    box-shadow:0 20px 60px rgba(20,30,50,0.12);
    padding:14px;
  }
  .modal h2{ margin:0 0 6px 0; font-size:16px; }
  .field { display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
  .field label{ font-size:13px; color:var(--muted); }
  .field input, .field textarea, .field select{
    padding:10px;
    border-radius:10px;
    border:1px solid #e9eef6;
    font-size:14px;
    outline:none;
    background:white;
  }
  .modal .row{ display:flex; gap:8px; }

  /* responsive */
  @media(min-width:760px){
    .plan { grid-template-columns:repeat(4,1fr); }
  }

  /* small helpers */
  .muted{ color:var(--muted); font-size:13px; }
  .small{ font-size:12px; color:var(--muted); }
  .segmented {
    display:inline-flex;
    background:rgba(10,10,10,0.03);
    padding:4px;
    border-radius:999px;
    gap:4px;
  }
  .segmented button{
    border:0;
    padding:8px 10px;
    border-radius:999px;
    background:transparent;
    cursor:pointer;
    font-weight:600;
    color:var(--muted);
  }
  .segmented button.active{
    background:white;
    box-shadow:0 6px 18px rgba(10,20,60,0.06);
    color:var(--accent);
  }

  /* empty state */
  .empty{
    text-align:center;
    padding:28px 8px;
    color:var(--muted);
  }

  /* tiny UX */
  .icon-btn{ background:transparent; border:0; padding:8px; border-radius:10px; cursor:pointer; }
</style>
</head>
<body>
<div class="app">
  <div class="frame">
    <header class="topbar">
      <div class="title">
        <h1>Admin • Клиенты</h1>
        <p>План на месяц • Адаптив для iPhone</p>
      </div>
      <div>
        <div class="segmented" role="tablist" aria-label="View toggle">
          <button id="viewList" class="active">Список</button>
          <button id="viewGrid">Карточки</button>
        </div>
      </div>
    </header>

    <main class="panel" role="main">
      <div class="controls">
        <button id="addClientBtn" class="btn">+ Добавить клиента</button>
        <button id="exportBtn" class="btn ghost">Экспорт</button>
        <button id="importBtn" class="btn ghost">Импорт</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>

      <section id="clientsContainer" class="clients" aria-live="polite">
        <!-- client cards rendered here -->
      </section>

      <div class="empty" id="emptyMsg" style="display:none;">
        Нет клиентов. Нажми «Добавить клиента», чтобы начать.
      </div>
    </main>
  </div>
</div>

<!-- modal -->
<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <h2 id="modalTitle">Новый клиент</h2>
    <div class="field">
      <label for="clientName">Имя</label>
      <input id="clientName" type="text" placeholder="Иван Иванов" />
    </div>
    <div class="field">
      <label for="clientPhone">Телефон</label>
      <input id="clientPhone" type="tel" placeholder="+7 900 000-00-00" />
    </div>
    <div class="field">
      <label for="clientNote">Заметка</label>
      <textarea id="clientNote" rows="2" placeholder="Комментарий..."></textarea>
    </div>

    <div style="margin-bottom:8px;">
      <label class="small muted">Месяц плана</label>
      <select id="planMonth" style="width:100%; margin-top:6px;">
        <!-- months populated by JS -->
      </select>
    </div>

    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button id="cancelBtn" class="btn ghost">Отмена</button>
      <button id="saveClientBtn" class="btn">Сохранить</button>
    </div>
  </div>
</div>

<!-- lightweight templates as JS strings -->
<script>
(() => {
  // Simple client admin with monthly plan structure
  const storageKey = 'admin_clients_v1';

  // DOM
  const addClientBtn = document.getElementById('addClientBtn');
  const modalBp = document.getElementById('modalBackdrop');
  const cancelBtn = document.getElementById('cancelBtn');
  const saveClientBtn = document.getElementById('saveClientBtn');
  const clientsContainer = document.getElementById('clientsContainer');
  const emptyMsg = document.getElementById('emptyMsg');
  const modalTitle = document.getElementById('modalTitle');

  const clientNameInput = document.getElementById('clientName');
  const clientPhoneInput = document.getElementById('clientPhone');
  const clientNoteInput = document.getElementById('clientNote');
  const planMonthSelect = document.getElementById('planMonth');

  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const importFile = document.getElementById('importFile');

  const viewListBtn = document.getElementById('viewList');
  const viewGridBtn = document.getElementById('viewGrid');

  let clients = [];
  let editingId = null;
  let viewMode = 'list';

  // months
  const months = [
    'Январь','Февраль','Март','Апрель','Май','Июнь',
    'Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'
  ];

  function uid(){
    return 'id_' + Math.random().toString(36).slice(2,9);
  }

  function defaultMonthPlan(year, monthIndex){
    // return plan as array of 4 weeks; each week is array of tasks
    const weeks = [];
    for(let w=0; w<4; w++){
      weeks.push([]);
    }
    return {year, monthIndex, weeks};
  }

  function load(){
    try {
      const raw = localStorage.getItem(storageKey);
      clients = raw ? JSON.parse(raw) : [];
    } catch(e){
      clients = [];
      console.error('load error', e);
    }
  }
  function save(){
    localStorage.setItem(storageKey, JSON.stringify(clients));
  }

  function renderClients(){
    clientsContainer.innerHTML = '';
    if(clients.length === 0){
      emptyMsg.style.display = 'block';
      return;
    }
    emptyMsg.style.display = 'none';

    clients.forEach(c => {
      const card = document.createElement('article');
      card.className = 'client-card';
      card.setAttribute('data-id', c.id);

      // header row
      const row = document.createElement('div');
      row.className = 'client-row';

      const info = document.createElement('div');
      info.className = 'client-info';

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = (c.name || '?').split(' ').map(s => s[0]).slice(0,2).join('').toUpperCase();

      const meta = document.createElement('div');
      meta.className = 'meta';
      const h3 = document.createElement('h3');
      h3.textContent = c.name || 'Без имени';
      const p = document.createElement('p');
      p.textContent = c.phone || '';

      meta.appendChild(h3);
      meta.appendChild(p);
      info.appendChild(avatar);
      info.appendChild(meta);

      const actions = document.createElement('div');
      actions.className = 'card-actions';
      // edit
      const editBtn = document.createElement('button');
      editBtn.className = 'icon-btn';
      editBtn.title = 'Редактировать';
      editBtn.innerHTML = '✏️';
      editBtn.addEventListener('click', () => openEditClient(c.id));

      // quick add task button
      const addTaskBtn = document.createElement('button');
      addTaskBtn.className = 'icon-btn';
      addTaskBtn.title = 'Добавить задачу в текущий месяц';
      addTaskBtn.innerHTML = '＋';
      addTaskBtn.addEventListener('click', () => openQuickTask(c.id));

      const delBtn = document.createElement('button');
      delBtn.className = 'icon-btn';
      delBtn.title = 'Удалить';
      delBtn.innerHTML = '🗑️';
      delBtn.addEventListener('click', () => {
        if(confirm('Удалить клиента?')) {
          clients = clients.filter(x => x.id !== c.id);
          save();
          renderClients();
        }
      });

      actions.appendChild(addTaskBtn);
      actions.appendChild(editBtn);
      actions.appendChild(delBtn);

      row.appendChild(info);
      row.appendChild(actions);
      card.appendChild(row);

      // note
      if(c.note){
        const note = document.createElement('div');
        note.className = 'small';
        note.textContent = c.note;
        card.appendChild(note);
      }

      // month label and plan preview
      const monthLabel = document.createElement('div');
      monthLabel.className = 'small muted';
      const mname = months[c.plan.monthIndex] || '—';
      monthLabel.textContent = `${mname} ${c.plan.year}`;
      card.appendChild(monthLabel);

      // plan preview (first 4 tasks)
      const preview = document.createElement('div');
      preview.style.marginTop = '8px';
      preview.style.display = 'grid';
      preview.style.gridTemplateColumns = 'repeat(2,1fr)';
      preview.style.gap = '6px';

      c.plan.weeks.forEach((wk, idx) => {
        const wdiv = document.createElement('div');
        wdiv.className = 'week';
        const wtitle = document.createElement('h4');
        wtitle.textContent = 'Неделя ' + (idx+1);
        wdiv.appendChild(wtitle);
        if(wk.length === 0){
          const em = document.createElement('div');
          em.className = 'small muted';
          em.textContent = 'Нет задач';
          wdiv.appendChild(em);
        } else {
          wk.slice(0,3).forEach(t => {
            const tdiv = document.createElement('div');
            tdiv.className = 'task';
            tdiv.innerHTML = `<div style="flex:1">${escapeHtml(t)}</div>`;
            wdiv.appendChild(tdiv);
          });
        }
        preview.appendChild(wdiv);
      });

      card.appendChild(preview);

      // expand button
      const expandRow = document.createElement('div');
      expandRow.style.display='flex';
      expandRow.style.justifyContent='flex-end';
      expandRow.style.marginTop='8px';
      const openBtn = document.createElement('button');
      openBtn.className='btn ghost';
      openBtn.textContent='Открыть план';
      openBtn.addEventListener('click', ()=> openPlanModal(c.id));
      expandRow.appendChild(openBtn);
      card.appendChild(expandRow);

      clientsContainer.appendChild(card);
    });

    // view mode tweaks
    if(viewMode === 'grid'){
      clientsContainer.style.gridTemplateColumns = 'repeat(2,1fr)';
    } else {
      clientsContainer.style.gridTemplateColumns = '1fr';
    }
  }

  // modal helpers
  function openNewClient(){
    editingId = null;
    modalTitle.textContent = 'Новый клиент';
    clientNameInput.value = '';
    clientPhoneInput.value = '';
    clientNoteInput.value = '';
    // default month: current
    const now = new Date();
    planMonthSelect.value = now.getMonth() + '|' + now.getFullYear();
    showModal();
  }

  function openEditClient(id){
    const c = clients.find(x=>x.id===id);
    if(!c) return;
    editingId = id;
    modalTitle.textContent = 'Редактирование';
    clientNameInput.value = c.name;
    clientPhoneInput.value = c.phone || '';
    clientNoteInput.value = c.note || '';
    planMonthSelect.value = c.plan.monthIndex + '|' + c.plan.year;
    showModal();
  }

  function showModal(){
    modalBp.classList.add('show');
    modalBp.setAttribute('aria-hidden','false');
    clientNameInput.focus();
  }
  function closeModal(){
    modalBp.classList.remove('show');
    modalBp.setAttribute('aria-hidden','true');
    editingId = null;
  }

  // on save
  saveClientBtn.addEventListener('click', () => {
    const name = clientNameInput.value.trim();
    if(!name){
      alert('Введите имя клиента');
      clientNameInput.focus();
      return;
    }
    const phone = clientPhoneInput.value.trim();
    const note = clientNoteInput.value.trim();
    const [mIdxStr, yearStr] = planMonthSelect.value.split('|');
    const monthIndex = parseInt(mIdxStr,10);
    const year = parseInt(yearStr,10);

    if(editingId){
      const c = clients.find(x=>x.id===editingId);
      if(c){
        c.name = name;
        c.phone = phone;
        c.note = note;
        c.plan.year = year;
        c.plan.monthIndex = monthIndex;
      }
    } else {
      const newClient = {
        id: uid(),
        name, phone, note,
        plan: defaultMonthPlan(year, monthIndex)
      };
      clients.unshift(newClient);
    }
    save();
    renderClients();
    closeModal();
  });

  cancelBtn.addEventListener('click', closeModal);
  modalBp.addEventListener('click', (e) => {
    if(e.target === modalBp) closeModal();
  });

  addClientBtn.addEventListener('click', openNewClient);

  // export/import
  exportBtn.addEventListener('click', () => {
    const dataStr = JSON.stringify(clients, null, 2);
    const blob = new Blob([dataStr], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'clients_export.json';
    a.click();
    URL.revokeObjectURL(url);
  });
  importBtn.addEventListener('click', ()=> importFile.click());
  importFile.addEventListener('change', (ev) => {
    const file = ev.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const parsed = JSON.parse(e.target.result);
        if(Array.isArray(parsed)){
          if(confirm('Импортировать и заменить текущую базу?')) {
            clients = parsed;
            save();
            renderClients();
            alert('Импорт выполнен');
          }
        } else alert('Некорректный файл');
      } catch(err){
        alert('Ошибка чтения файла');
      }
    };
    reader.readAsText(file);
    ev.target.value = '';
  });

  // quick task add: opens small inline prompt to add a task into week 1 by default
  function openQuickTask(clientId){
    const client = clients.find(x=>x.id===clientId);
    if(!client) return;
    const task = prompt('Добавить задачу в первый неделю:');
    if(task && task.trim()){
      client.plan.weeks[0].push(task.trim());
      save();
      renderClients();
    }
  }

  // plan modal: create a quick editor overlay for full month plan
  function openPlanModal(clientId){
    const client = clients.find(x=>x.id===clientId);
    if(!client) return;
    // build simple prompt UI
    const modal = document.createElement('div');
    modal.style.position='fixed';
    modal.style.inset='0';
    modal.style.zIndex='120';
    modal.style.display='flex';
    modal.style.alignItems='center';
    modal.style.justifyContent='center';
    modal.style.padding='20px';
    modal.style.backdropFilter='blur(6px)';
    modal.innerHTML = `
      <div style="width:100%;max-width:680px;background:white;border-radius:14px;padding:14px;box-shadow:0 30px 80px rgba(20,30,50,0.12);max-height:90vh;overflow:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div>
            <h3 style="margin:0 0 4px 0">${escapeHtml(client.name)} — план</h3>
            <div class="small muted">${months[client.plan.monthIndex] || ''} ${client.plan.year}</div>
          </div>
          <div>
            <button id="closePlan" class="btn ghost">Закрыть</button>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    const grid = modal.querySelector('div > div:nth-child(2)');

    // render weeks with add/remove
    client.plan.weeks.forEach((wk, widx) => {
      const wdiv = document.createElement('div');
      wdiv.style.background='linear-gradient(180deg,#fff,#fbfbff)';
      wdiv.style.padding='10px';
      wdiv.style.borderRadius='12px';
      wdiv.innerHTML = `<h4 style="margin:0 0 8px 0">Неделя ${widx+1}</h4>`;
      const list = document.createElement('div');
      list.style.display='flex';
      list.style.flexDirection='column';
      list.style.gap='8px';
      wk.forEach((task, tidx) => {
        const row = document.createElement('div');
        row.style.display='flex';
        row.style.gap='8px';
        const inp = document.createElement('input');
        inp.type='text';
        inp.value = task;
        inp.style.flex='1';
        inp.style.padding='8px';
        inp.style.borderRadius='8px';
        inp.style.border='1px solid #eef2f7';
        inp.addEventListener('input', (e) => {
          client.plan.weeks[widx][tidx] = e.target.value;
          save();
        });
        const del = document.createElement('button');
        del.textContent='✕';
        del.style.background='transparent';
        del.style.border='0';
        del.style.cursor='pointer';
        del.addEventListener('click', () => {
          client.plan.weeks[widx].splice(tidx,1);
          save();
          modal.remove();
          openPlanModal(clientId);
        });
        row.appendChild(inp);
        row.appendChild(del);
        list.appendChild(row);
      });
      const addRow = document.createElement('div');
      addRow.style.display='flex';
      addRow.style.gap='8px';
      addRow.style.marginTop='8px';
      const newInp = document.createElement('input');
      newInp.type='text';
      newInp.placeholder='Новая задача...';
      newInp.style.flex='1';
      const addBtn = document.createElement('button');
      addBtn.className='btn';
      addBtn.textContent='Добавить';
      addBtn.addEventListener('click', () => {
        const v = newInp.value.trim();
        if(v){
          client.plan.weeks[widx].push(v);
          save();
          modal.remove();
          openPlanModal(clientId);
        }
      });
      addRow.appendChild(newInp);
      addRow.appendChild(addBtn);

      wdiv.appendChild(list);
      wdiv.appendChild(addRow);
      grid.appendChild(wdiv);
    });

    modal.querySelector('#closePlan').addEventListener('click', () => {
      modal.remove();
      renderClients();
    });
    // click outside closes
    modal.addEventListener('click', (e) => {
      if(e.target === modal) {
        modal.remove();
        renderClients();
      }
    });
  }

  // init month options
  function populateMonths(){
    const now = new Date();
    for(let i=-2;i<=2;i++){ // show range around current month
      const d = new Date(now.getFullYear(), now.getMonth()+i, 1);
      const opt = document.createElement('option');
      opt.value = d.getMonth() + '|' + d.getFullYear();
      opt.textContent = months[d.getMonth()] + ' ' + d.getFullYear();
      planMonthSelect.appendChild(opt);
    }
    // ensure at least current is selected
    planMonthSelect.value = now.getMonth() + '|' + now.getFullYear();
  }

  function escapeHtml(str){
    if(!str) return '';
    return String(str).replace(/[&<>"']/g, function(m){
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
  }

  // view toggles
  viewListBtn.addEventListener('click', ()=>{
    viewMode='list';
    viewListBtn.classList.add('active');
    viewGridBtn.classList.remove('active');
    renderClients();
  });
  viewGridBtn.addEventListener('click', ()=>{
    viewMode='grid';
    viewGridBtn.classList.add('active');
    viewListBtn.classList.remove('active');
    renderClients();
  });

  // initial load
  populateMonths();
  load();
  renderClients();

  // expose for debugging in console (optional)
  window.adminApp = {
    clients,
    save,
    load,
    renderClients
  };

})();
</script>
</body>
</html>
