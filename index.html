<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Админ · Клиенты</title>
  <style>
    :root{
      --bg: #0b0b0c;
      --card:#151517;
      --elev:#1b1b1e;
      --text:#ffffff;
      --muted:#9a9aa0;
      --tint:#0a84ff; /* iOS голубой */
      --success:#30d158;
      --danger:#ff453a;
      --sep:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.4);
      --radius: 16px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7f9; --card:#ffffff; --elev:#f2f2f7; --text:#000; --muted:#6b6b70;
        --sep:rgba(0,0,0,.08); --shadow:0 8px 24px rgba(0,0,0,.06);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      line-height:1.35;
    }
    .safe{padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom)}
    .wrap{
      max-width: 430px; /* iPhone 15 Pro Max width-friendly */
      margin: 0 auto;
      min-height:100%;
      display:flex; flex-direction:column;
    }
    header{
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: saturate(180%) blur(20px);
      background: color-mix(in oklab, var(--bg) 80%, transparent);
      border-bottom: 1px solid var(--sep);
    }
    .topbar{
      display:flex; align-items:center; gap:10px;
      padding: 14px 16px;
    }
    .title{
      font-weight: 700; font-size: 18px; letter-spacing:.2px;
      flex:1;
    }
    .ios-btn{
      appearance:none; border:0; cursor:pointer;
      padding: 10px 14px; border-radius: 12px;
      background: var(--tint); color:#fff; font-weight:600;
      box-shadow: 0 6px 16px color-mix(in oklab, var(--tint) 30%, transparent);
      transition: transform .06s ease;
    }
    .ios-btn:active{transform: scale(.98)}
    .ios-btn.ghost{
      background: transparent; color: var(--tint);
      border: 1px solid color-mix(in oklab, var(--tint) 30%, var(--sep));
      box-shadow:none;
    }
    main{flex:1; padding: 16px; display:flex; flex-direction:column; gap:16px}
    .card{
      background: var(--card); border:1px solid var(--sep);
      border-radius: var(--radius); box-shadow: var(--shadow);
    }
    .card-pad{padding: 16px}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .stat{
      display:flex; flex-direction:column; gap:6px; padding:12px; border-radius:14px;
      background: var(--elev); border:1px solid var(--sep);
      text-align:center;
    }
    .stat .num{font-weight:800; font-size:28px}
    .muted{color:var(--muted); font-size:13px}
    label{font-size:13px; color:var(--muted)}
    input, textarea, select{
      width:100%; padding:12px 14px; border-radius:12px;
      border:1px solid var(--sep); background: var(--elev); color:var(--text);
      outline: none;
    }
    input:focus, textarea:focus{border-color: color-mix(in oklab, var(--tint) 50%, var(--sep)); box-shadow:0 0 0 4px color-mix(in oklab, var(--tint) 20%, transparent)}
    form .row{display:flex; flex-direction:column; gap:6px; margin-bottom:12px}
    .list{display:flex; flex-direction:column}
    .item{
      display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center;
      padding:12px 14px; border-top:1px solid var(--sep);
    }
    .item:first-child{border-top:none}
    .name{font-weight:600}
    .note{font-size:13px; color:var(--muted)}
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--sep); background: var(--elev)
    }
    .row-inline{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .seg{
      display:flex; gap:6px; background: var(--elev); padding:6px; border-radius: 12px; border:1px solid var(--sep)
    }
    .seg button{
      flex:1; padding:8px 12px; border-radius:10px; border:0; background: transparent; color:var(--muted); font-weight:600
    }
    .seg button.active{background: var(--card); color: var(--text); border:1px solid var(--sep)}
    .danger{color: var(--danger)}
    .ok{color: var(--success)}
    footer{
      padding: 16px; border-top:1px solid var(--sep);
      display:flex; gap:10px; justify-content:space-between; flex-wrap:wrap
    }
    .hint{
      font-size:12px; color:var(--muted); padding: 0 16px 16px;
    }
    .hidden{display:none !important}
    /* Логин */
    .login{
      max-width:430px; margin:0 auto; min-height:100dvh; display:flex; flex-direction:column; justify-content:center; gap:18px; padding:24px;
    }
    .brand{
      font-size:28px; font-weight:800; letter-spacing:.2px;
      text-align:center; margin-bottom:6px;
    }
    .badge{font-size:11px; color:var(--muted); text-align:center}
  </style>
</head>
<body class="safe">
<div class="wrap" id="app">

  <!-- LOGIN SCREEN -->
  <section id="screen-login" class="login">
    <div class="brand">Админ · Клиенты</div>
    <div class="badge">Доступ только для администратора</div>
    <div class="card card-pad">
      <form id="login-form">
        <div class="row">
          <label for="password">Пароль администратора</label>
          <input id="password" type="password" inputmode="text" autocomplete="current-password" placeholder="Введите пароль" required>
        </div>
        <button class="ios-btn" type="submit">Войти</button>
      </form>
      <div id="login-tip" class="hint"></div>
    </div>
  </section>

  <!-- APP SCREEN -->
  <section id="screen-app" class="hidden">
    <header>
      <div class="topbar">
        <div class="title">Клиенты</div>
        <button id="btn-settings" class="ios-btn ghost" aria-label="Настройки">⚙️</button>
        <button id="btn-logout" class="ios-btn ghost" aria-label="Выйти">Выйти</button>
      </div>
      <div class="topbar">
        <div class="seg" role="tablist" aria-label="Разделы">
          <button id="tab-dashboard" class="active" role="tab">Сводка</button>
          <button id="tab-add" role="tab">Добавить</button>
          <button id="tab-list" role="tab">Список</button>
        </div>
      </div>
    </header>

    <main>
      <!-- DASHBOARD -->
      <div id="panel-dashboard" class="card card-pad">
        <div class="grid-2">
          <div class="stat">
            <div class="muted" id="month-label">Этот месяц</div>
            <div class="num" id="month-count">0</div>
          </div>
          <div class="stat">
            <div class="muted">Всего клиентов</div>
            <div class="num" id="total-count">0</div>
          </div>
        </div>
        <div class="hint" id="pwd-warning"></div>
      </div>

      <!-- ADD -->
      <div id="panel-add" class="card card-pad hidden">
        <form id="add-form" autocomplete="off">
          <div class="row">
            <label for="name">Имя клиента *</label>
            <input id="name" placeholder="Например, Иван Петров" required>
          </div>
          <div class="row">
            <label for="phone">Телефон</label>
            <input id="phone" placeholder="+7 999 123-45-67" inputmode="tel" autocomplete="tel">
          </div>
          <div class="row">
            <label for="note">Заметка</label>
            <textarea id="note" placeholder="Комментарий" rows="3"></textarea>
          </div>
          <button class="ios-btn" type="submit">Добавить клиента</button>
        </form>
      </div>

      <!-- LIST -->
      <div id="panel-list" class="card">
        <div class="card-pad">
          <div class="row-inline" style="justify-content:space-between">
            <div class="row-inline">
              <label for="filter-month">Месяц:</label>
              <input id="filter-month" type="month">
              <button id="btn-filter-clear" class="ios-btn ghost">Сброс</button>
            </div>
            <div class="row-inline">
              <button id="btn-export" class="ios-btn ghost" title="Экспорт JSON">Экспорт</button>
              <input id="file-import" type="file" accept="application/json" class="hidden">
              <button id="btn-import" class="ios-btn ghost" title="Импорт JSON">Импорт</button>
            </div>
          </div>
        </div>
        <div id="list" class="list"></div>
      </div>

      <!-- SETTINGS -->
      <div id="panel-settings" class="card card-pad hidden">
        <h3 style="margin:0 0 12px 0">Настройки</h3>
        <form id="pwd-form">
          <div class="row">
            <label for="new-password">Новый пароль администратора</label>
            <input id="new-password" type="password" autocomplete="new-password" placeholder="Придумайте сложный пароль">
          </div>
          <button class="ios-btn" type="submit">Сменить пароль</button>
        </form>
        <div class="hint">Совет: используйте длинную фразу, не короче 12 символов.</div>
        <button id="btn-wipe" class="ios-btn danger" style="background:transparent;border:1px solid var(--danger); color:var(--danger)">Стереть все данные</button>
      </div>
    </main>

    <footer>
      <div class="muted">Локальное хранилище браузера. Данные остаются на этом устройстве.</div>
      <div class="pill" id="last-sync">Сохранено…</div>
    </footer>
  </section>
</div>

<script>
/* =======================
   Простая архитектура данных
   Хранение: localStorage (клиенты) + sessionStorage (сессия)
   Авторизация: SHA-256( salt + password ) через WebCrypto
   ======================= */

const STORAGE_KEYS = {
  clients: 'clients_v1',
  adminSalt: 'admin_salt_v1',
  adminHash: 'admin_hash_v1',
};
const DEFAULT_PASSWORD = 'admin123'; // ← поменяйте позже в Настройках
const state = {
  clients: [],
  logged: false,
  monthNow: new Date()
};

const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

/* ---------- УТИЛИТЫ ---------- */
const te = new TextEncoder();
function b64(bytes){ return btoa(String.fromCharCode(...new Uint8Array(bytes))); }
function genSalt(len=16){
  const b = new Uint8Array(len); crypto.getRandomValues(b); return b64(b);
}
async function sha256Base64(str){
  const buf = await crypto.subtle.digest('SHA-256', te.encode(str));
  return b64(buf);
}
async function hashPassword(password, salt){
  return await sha256Base64(salt + password);
}
function saveClients(){
  localStorage.setItem(STORAGE_KEYS.clients, JSON.stringify(state.clients));
  $('#last-sync').textContent = 'Сохранено ' + new Date().toLocaleString();
  updateUI();
}
function loadClients(){
  try{
    state.clients = JSON.parse(localStorage.getItem(STORAGE_KEYS.clients) || '[]');
  }catch{ state.clients = []; }
}
function ensureAdminSecret(){
  let salt = localStorage.getItem(STORAGE_KEYS.adminSalt);
  let hash = localStorage.getItem(STORAGE_KEYS.adminHash);
  if(!salt || !hash){
    salt = genSalt(16);
    hash = (async () => {
      const h = await hashPassword(DEFAULT_PASSWORD, salt);
      localStorage.setItem(STORAGE_KEYS.adminSalt, salt);
      localStorage.setItem(STORAGE_KEYS.adminHash, h);
      return h;
    })();
  }
}

/* ---------- АВТОРИЗАЦИЯ ---------- */
async function login(password){
  const salt = localStorage.getItem(STORAGE_KEYS.adminSalt);
  const realHash = localStorage.getItem(STORAGE_KEYS.adminHash);
  if(!salt || !realHash){
    // инициализация
    const newSalt = genSalt(16);
    const newHash = await hashPassword(DEFAULT_PASSWORD, newSalt);
    localStorage.setItem(STORAGE_KEYS.adminSalt, newSalt);
    localStorage.setItem(STORAGE_KEYS.adminHash, newHash);
  }
  const checkSalt = localStorage.getItem(STORAGE_KEYS.adminSalt);
  const calc = await hashPassword(password, checkSalt);
  if(calc === localStorage.getItem(STORAGE_KEYS.adminHash)){
    sessionStorage.setItem('session_ok', '1');
    state.logged = true;
    showApp();
    return true;
  }else{
    return false;
  }
}
function logout(){
  sessionStorage.removeItem('session_ok');
  state.logged = false;
  showLogin();
}

/* ---------- UI ---------- */
function showLogin(){
  $('#screen-login').classList.remove('hidden');
  $('#screen-app').classList.add('hidden');
  const tip = $('#login-tip');
  const defaultHash = (async ()=>{
    const salt = localStorage.getItem(STORAGE_KEYS.adminSalt);
    const hash = localStorage.getItem(STORAGE_KEYS.adminHash);
    // если хэш соответствует паролю по умолчанию — подсказка
    if(salt && hash){
      const h = await hashPassword(DEFAULT_PASSWORD, salt);
      if(h === hash){
        tip.textContent = 'Пароль по умолчанию: admin123 — смените после входа в «Настройках».';
      } else {
        tip.textContent = '';
      }
    }
  })();
}
function showApp(){
  $('#screen-login').classList.add('hidden');
  $('#screen-app').classList.remove('hidden');
  updateUI();
}
function switchTab(tab){
  const panels = {
    'dashboard': '#panel-dashboard',
    'add': '#panel-add',
    'list': '#panel-list'
  };
  $$('#panel-dashboard, #panel-add, #panel-list').forEach(n=>n.classList.add('hidden'));
  $(`#${panels[tab]?.slice(1)}`).classList.remove('hidden');
  $$('#tab-dashboard, #tab-add, #tab-list').forEach(b=>b.classList.remove('active'));
  $(`#tab-${tab}`).classList.add('active');
}
function updateUI(){
  // Сводка
  const now = new Date();
  const monthLabel = now.toLocaleDateString('ru-RU', {month:'long', year:'numeric'});
  $('#month-label').textContent = monthLabel.charAt(0).toUpperCase() + monthLabel.slice(1);
  const mCount = countForMonth(now.getFullYear(), now.getMonth());
  $('#month-count').textContent = String(mCount);
  $('#total-count').textContent = String(state.clients.length);

  // Предупреждение о дефолтном пароле
  (async ()=>{
    const salt = localStorage.getItem(STORAGE_KEYS.adminSalt);
    const hash = localStorage.getItem(STORAGE_KEYS.adminHash);
    const def = salt && hash ? await hashPassword(DEFAULT_PASSWORD, salt) : '';
    $('#pwd-warning').innerHTML = (def && def === hash)
      ? '⚠️ У вас установлен пароль по умолчанию. Пожалуйста, смените его в «Настройках».'
      : '';
  })();

  // Список
  renderList();
}
function renderList(){
  const container = $('#list');
  container.innerHTML = '';
  const filterVal = $('#filter-month').value; // "YYYY-MM"
  const items = state.clients
    .filter(c=>{
      if(!filterVal) return true;
      const d = new Date(c.createdAt);
      const ym = d.toISOString().slice(0,7);
      return ym === filterVal;
    })
    .sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));

  if(items.length === 0){
    container.innerHTML = '<div class="card-pad muted">Пока пусто.</div>';
    return;
  }

  items.forEach(c=>{
    const div = document.createElement('div');
    div.className = 'item';
    const dt = new Date(c.createdAt);
    const when = dt.toLocaleString('ru-RU', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});
    div.innerHTML = `
      <div>
        <div class="name">${escapeHtml(c.name)}</div>
        <div class="note">${escapeHtml(c.phone || '')} ${c.phone && c.note ? '· ' : ''}${escapeHtml(c.note || '')}</div>
      </div>
      <div class="pill" title="${dt.toLocaleString()}">${when}</div>
    `;
    div.addEventListener('contextmenu', (e)=>{ e.preventDefault(); confirmDelete(c.id); });
    container.appendChild(div);
  });
}
function escapeHtml(s){
  return String(s).replace(/[&<>"'`=\/]/g, ch => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
  }[ch]));
}
function countForMonth(year, monthIndex){
  return state.clients.filter(c=>{
    const d = new Date(c.createdAt);
    return d.getFullYear()===year && d.getMonth()===monthIndex;
  }).length;
}

/* ---------- СОБЫТИЯ ---------- */
$('#login-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const ok = await login($('#password').value);
  if(!ok){
    $('#login-tip').textContent = 'Неверный пароль. Попробуйте ещё раз.';
  }
});
$('#btn-logout').addEventListener('click', ()=> logout());

$('#tab-dashboard').addEventListener('click', ()=> switchTab('dashboard'));
$('#tab-add').addEventListener('click', ()=> switchTab('add'));
$('#tab-list').addEventListener('click', ()=> switchTab('list'));

$('#add-form').addEventListener('submit', (e)=>{
  e.preventDefault();
  const name = $('#name').value.trim();
  if(!name){ $('#name').focus(); return; }
  const obj = {
    id: crypto.randomUUID(),
    name,
    phone: $('#phone').value.trim(),
    note: $('#note').value.trim(),
    createdAt: new Date().toISOString()
  };
  state.clients.push(obj);
  saveClients();
  $('#add-form').reset();
  switchTab('list');
});

$('#filter-month').addEventListener('change', renderList);
$('#btn-filter-clear').addEventListener('click', ()=>{ $('#filter-month').value=''; renderList(); });

$('#btn-export').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state.clients, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'clients_export.json';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

$('#btn-import').addEventListener('click', ()=> $('#file-import').click());
$('#file-import').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  try{
    const text = await file.text();
    const arr = JSON.parse(text);
    if(!Array.isArray(arr)) throw new Error('Неверный формат');
    // простая нормализация
    arr.forEach(x=>{
      if(!x.id) x.id = crypto.randomUUID();
      if(!x.createdAt) x.createdAt = new Date().toISOString();
    });
    state.clients = arr;
    saveClients();
    alert('Импорт выполнен');
  }catch(err){
    alert('Ошибка импорта: ' + err.message);
  }finally{
    e.target.value = '';
  }
});

$('#btn-settings').addEventListener('click', ()=>{
  const panel = $('#panel-settings');
  panel.classList.toggle('hidden');
  if(!panel.classList.contains('hidden')) window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
});

$('#pwd-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const pwd = $('#new-password').value.trim();
  if(pwd.length < 6){ alert('Пароль слишком короткий'); return; }
  const newSalt = genSalt(16);
  const newHash = await hashPassword(pwd, newSalt);
  localStorage.setItem(STORAGE_KEYS.adminSalt, newSalt);
  localStorage.setItem(STORAGE_KEYS.adminHash, newHash);
  $('#new-password').value='';
  alert('Пароль изменён. Не забудьте его!');
  updateUI();
});

$('#btn-wipe').addEventListener('click', ()=>{
  if(confirm('Стереть ВСЕ записи клиентов и сбросить настройки?')){
    localStorage.removeItem(STORAGE_KEYS.clients);
    // Пароль сохранить, чтобы вход не сломался:
    state.clients = [];
    saveClients();
    renderList();
    alert('Готово. Список очищен.');
  }
});

/* ---------- ИНИЦИАЛИЗАЦИЯ ---------- */
(function init(){
  ensureAdminSecret();
  loadClients();
  if(sessionStorage.getItem('session_ok') === '1'){
    state.logged = true; showApp();
  } else {
    showLogin();
  }
})();
</script>
</body>
</html>
