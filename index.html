<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Клиенты</title>

  <!-- iOS "как приложение" -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- (Необязательно для iOS) Встроенный webmanifest как data: URL -->
  <link rel="manifest" href='data:application/manifest+json,{"name":"%D0%9A%D0%BB%D0%B8%D0%B5%D0%BD%D1%82%D1%8B","short_name":"%D0%9A%D0%BB%D0%B8%D0%B5%D0%BD%D1%82%D1%8B","start_url":"./index.html","display":"standalone","background_color":"#ffffff","theme_color":"#0A84FF","icons":[{"src":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAAAAABbnd/AAAAAklEQVR4AewaftIAAABNSURBVO3BQQEAAAgDoK1/aQ8YAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgYhFBAABx0y9dwAAAABJRU5ErkJggg==","sizes":"192x192","type":"image/png"},{"src":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAAAAAB1V6mUAAAAAklEQVR4AewaftIAAABNSURBVO3BQQEAAAgDoK1/aQ8YAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgYhFBAABx0y9dwAAAABJRU5ErkJggg==","sizes":"512x512","type":"image/png"}]}'>

  <!-- Встроенная иконка для iOS (можешь заменить на свою data: или файл) -->
  <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQA...trimmed">

  <style>
    :root{
      --bg: rgba(248,248,250,1);
      --card: rgba(255,255,255,0.7);
      --border: rgba(0,0,0,0.1);
      --text: #111;
      --sub: #666;
      --tint: #0A84FF;
      --danger: #FF453A;
      --success: #34C759;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 14px;
      --blur: 20px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg: #000;
        --card: rgba(28,28,30,0.6);
        --border: rgba(255,255,255,0.08);
        --text: #fff;
        --sub: #aaa;
        --shadow: 0 10px 30px rgba(0,0,0,.5);
      }
    }
    *{box-sizing:border-box}
    html,body{
      margin:0; padding:0;
      background: var(--bg);
      color: var(--text);
      font: 16px -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      -webkit-text-size-adjust:100%;
      height:100%;
    }
    .app{
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      min-height:100dvh;
      display:flex; flex-direction:column;
    }
    .nav{
      position: sticky; top:0; z-index:50;
      backdrop-filter: saturate(180%) blur(20px);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      background: rgba(255,255,255,0.6);
      border-bottom: 1px solid var(--border);
      padding: calc(8px + env(safe-area-inset-top)) 16px 8px;
    }
    @media (prefers-color-scheme: dark){
      .nav{ background: rgba(20,20,22,0.6); }
    }
    .titleLarge{
      font-weight:700; font-size: 34px; line-height:1.1; letter-spacing:-.02em;
      margin: 6px 0 0;
    }
    .toolbar{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .searchBox{
      display:flex; align-items:center; gap:8px; width:100%;
      background: var(--card); border:1px solid var(--border); box-shadow: var(--shadow);
      border-radius: 12px; padding: 10px 12px;
    }
    .searchBox input{
      flex:1; border:0; outline:none; background:transparent; color:var(--text);
      font-size:16px;
    }
    .btn{
      -webkit-tap-highlight-color: transparent;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 14px; border-radius: 12px; border:1px solid var(--border);
      background: var(--card); color: var(--text); font-weight:600;
      box-shadow: var(--shadow);
    }
    .btn.primary{ background: var(--tint); color:#fff; border-color: transparent; }
    .btn.ghost{ background: transparent; }
    .btn.danger{ background: var(--danger); color:#fff; border-color: transparent; }

    .content{ padding: 16px; display:flex; flex-direction:column; gap:12px; }
    .pillbar{ display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch; padding:4px 0 8px; }
    .pill{
      padding:8px 12px; border-radius:999px; border:1px solid var(--border); background: var(--card);
      white-space:nowrap; font-weight:600;
    }
    .pill.active{ background: var(--tint); color:#fff; border-color: transparent;}

    .card{
      background: var(--card); border:1px solid var(--border); border-radius: var(--radius);
      box-shadow: var(--shadow); padding:14px; display:flex; flex-direction:column; gap:8px;
    }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .name{ font-weight:700; font-size:17px; letter-spacing:-.01em; }
    .sub{ color: var(--sub); font-size:14px; }
    .tags{ display:flex; gap:6px; flex-wrap:wrap; }
    .tag{ font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background: rgba(0,0,0,0.04);}
    @media (prefers-color-scheme: dark){ .tag{ background: rgba(255,255,255,0.06); } }
    .actions{ display:flex; gap:8px; }
    .empty{ text-align:center; opacity:.7; padding:40px 16px;}

    .sheet{
      position: fixed; left:0; right:0; bottom:-100%;
      background: rgba(255,255,255,0.9);
      -webkit-backdrop-filter: blur(var(--blur));
      backdrop-filter: blur(var(--blur));
      border-top-left-radius: 20px; border-top-right-radius: 20px;
      box-shadow: 0 -20px 40px rgba(0,0,0,0.15);
      transition: bottom .28s ease; z-index:100;
      border-top: 1px solid var(--border);
      padding-bottom: env(safe-area-inset-bottom);
    }
    .sheet.open{ bottom:0; }
    @media (prefers-color-scheme: dark){ .sheet{ background: rgba(20,20,22,0.9); } }
    .sheetHeader{ padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .sheetBody{ padding: 0 16px 16px; }
    .grip{ width:44px; height:5px; background: var(--border); border-radius:999px; margin:8px auto 4px; }

    .field{ display:flex; flex-direction:column; gap:6px; margin:12px 0; }
    .field label{ font-size:13px; color:var(--sub); }
    .field input, .field textarea{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background: var(--card); color:var(--text); outline:none;
    }
    .field textarea{ min-height:90px; resize:vertical; }

    .toast{
      position: fixed; left:50%; transform: translateX(-50%);
      bottom: calc(20px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,.85); color:#fff; padding:10px 14px; border-radius:12px;
      opacity:0; pointer-events:none; transition: opacity .25s, transform .25s; z-index:200;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-6px); }

    input, button, textarea{ font: inherit; }
    button{ border:0; background:none; padding:0; }
    a{ color:var(--tint); text-decoration:none; }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
<div class="app">
  <div class="nav">
    <div class="toolbar">
      <div class="searchBox" style="flex:1">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23C15.99 6.01 13.48 3.5 10.49 3.5S5 6.01 5 9s2.51 5.5 5.5 5.5a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l4.25 4.25c.41.41 1.09.41 1.5 0s.41-1.09 0-1.5L15.5 14Zm-5 0C8.01 14 6 11.99 6 9.5S8.01 5 10.5 5 15 7.01 15 9.5 12.99 14 10.5 14Z"/></svg>
        <input id="search" placeholder="Поиск по имени, телефону, тегам…" autocomplete="off">
      </div>
      <button id="addBtn" class="btn primary">Добавить</button>
    </div>
    <div class="titleLarge">Клиенты</div>
  </div>

  <div class="content">
    <div class="pillbar">
      <button class="pill active" data-filter="all">Все</button>
      <button class="pill" data-filter="recent">Недавно</button>
      <button class="pill" data-filter="tag:VIP">VIP</button>
      <button class="pill" data-filter="tag:Новый">Новый</button>
    </div>

    <div class="row">
      <div class="sub" id="count">0 клиентов</div>
      <div class="actions">
        <button id="exportBtn" class="btn ghost">Экспорт</button>
        <label class="btn ghost" style="cursor:pointer">Импорт <input id="importInput" type="file" accept="application/json" class="hidden"></label>
        <button id="clearBtn" class="btn danger">Очистить</button>
      </div>
    </div>

    <div id="list"></div>
    <div id="empty" class="empty hidden">Пока пусто. Нажми «Добавить», чтобы создать первого клиента.</div>
  </div>
</div>

<!-- Лист (форма) -->
<div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
  <div class="grip"></div>
  <div class="sheetHeader">
    <div style="font-weight:700" id="sheetTitle">Новый клиент</div>
    <div class="actions">
      <button id="cancelBtn" class="btn ghost">Отмена</button>
      <button id="saveBtn" class="btn primary">Сохранить</button>
    </div>
  </div>
  <div class="sheetBody">
    <form id="form" onsubmit="return false;">
      <input type="hidden" id="clientId">
      <div class="field">
        <label for="name">Имя *</label>
        <input id="name" placeholder="Например, Ирина Петрова" required>
      </div>
      <div class="field">
        <label for="phone">Телефон</label>
        <input id="phone" inputmode="tel" placeholder="+7 900 000-00-00">
      </div>
      <div class="field">
        <label for="email">Email</label>
        <input id="email" type="email" inputmode="email" placeholder="name@example.com">
      </div>
      <div class="field">
        <label for="tags">Теги (через запятую)</label>
        <input id="tags" placeholder="VIP, Новый">
      </div>
      <div class="field">
        <label for="notes">Заметки</label>
        <textarea id="notes" placeholder="Любые комментарии…"></textarea>
      </div>
      <div class="row">
        <div class="sub">Создано: <span id="createdAtLabel">—</span></div>
        <div class="sub">Обновлено: <span id="updatedAtLabel">—</span></div>
      </div>
    </form>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite">Готово</div>

<script>
/* ====== Хранение ====== */
const KEY = 'clients.v1';
const load = () => { try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch(e){ return []; } };
const save = (arr) => localStorage.setItem(KEY, JSON.stringify(arr));

/* ====== Утилиты ====== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const uid = () => crypto.randomUUID ? crypto.randomUUID() : ('id-' + Math.random().toString(36).slice(2));
const nowISO = () => new Date().toISOString();
const fmt = iso => iso ? new Date(iso).toLocaleString() : '—';
const toast = (msg) => { const t = $('#toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1800); };
const escapeHtml = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));

/* Склонение */
function decl(n, forms){
  const n10 = n % 10, n100 = n % 100;
  if(n10 === 1 && n100 !== 11) return forms[0];
  if(n10 >= 2 && n10 <= 4 && (n100 < 10 || n100 >= 20)) return forms[1];
  return forms[2];
}

/* ====== Состояние ====== */
let clients = load();
let filter = 'all';
let q = '';

/* ====== Рендер ====== */
const render = () => {
  const list = $('#list'); list.innerHTML = '';
  const filtered = clients
    .filter(c => {
      if(q){
        const s = (c.name+' '+(c.phone||'')+' '+(c.email||'')+' '+(c.tags||[]).join(' ')).toLowerCase();
        if(!s.includes(q.toLowerCase())) return false;
      }
      if(filter === 'recent'){
        const d = new Date(); const weekAgo = new Date(d.getTime()-7*24*3600*1000);
        return new Date(c.updatedAt||c.createdAt) >= weekAgo;
      }
      if(filter.startsWith('tag:')){
        const tag = filter.split(':')[1];
        return (c.tags||[]).includes(tag);
      }
      return true;
    })
    .sort((a,b)=> (b.updatedAt||b.createdAt||'').localeCompare(a.updatedAt||a.createdAt||''));

  $('#count').textContent = `${clients.length} ${decl(clients.length, ['клиент','клиента','клиентов'])}`;

  if(filtered.length === 0){
    $('#empty').classList.remove('hidden');
    return;
  } else {
    $('#empty').classList.add('hidden');
  }

  for(const c of filtered){
    const card = document.createElement('div');
    card.className = 'card';

    const top = document.createElement('div'); top.className='row';
    const left = document.createElement('div');
    left.innerHTML = `
      <div class="name">${escapeHtml(c.name)}</div>
      <div class="sub">${escapeHtml(c.phone||'')}${c.phone&&c.email?' · ':''}${escapeHtml(c.email||'')}</div>
    `;
    const right = document.createElement('div'); right.className='actions';
    right.innerHTML = `
      <button class="btn ghost" data-edit="${c.id}">Редактировать</button>
      <button class="btn danger" data-del="${c.id}">Удалить</button>
    `;
    top.append(left, right);

    const tags = document.createElement('div'); tags.className='tags';
    (c.tags||[]).forEach(t=>{
      const el = document.createElement('span');
      el.className='tag'; el.textContent = t;
      tags.appendChild(el);
    });

    const meta = document.createElement('div'); meta.className='sub';
    meta.textContent = `Создано: ${fmt(c.createdAt)} · Обновлено: ${fmt(c.updatedAt||c.createdAt)}`;

    card.append(top);
    if((c.tags||[]).length) card.append(tags);
    if(c.notes){ const n = document.createElement('div'); n.className='sub'; n.textContent = c.notes; card.append(n); }
    card.append(meta);

    list.append(card);
  }

  $$('#list [data-edit]').forEach(b=> b.onclick = () => openEdit(b.getAttribute('data-edit')));
  $$('#list [data-del]').forEach(b=> b.onclick = () => delClient(b.getAttribute('data-del')));
};

/* ====== CRUD ====== */
const upsert = (data) => {
  const idx = clients.findIndex(x=>x.id===data.id);
  if(idx>=0){ clients[idx] = {...clients[idx], ...data, updatedAt: nowISO()}; }
  else { clients.unshift({...data, createdAt: nowISO()}); }
  save(clients); render();
};
const delClient = (id) => {
  if(!confirm('Удалить клиента?')) return;
  clients = clients.filter(c=>c.id!==id); save(clients); render(); toast('Удалено');
};

/* ====== Форма ====== */
const sheet = $('#sheet');
const openSheet = () => sheet.classList.add('open');
const closeSheet = () => sheet.classList.remove('open');

const openNew = () => {
  $('#sheetTitle').textContent = 'Новый клиент';
  $('#clientId').value = '';
  $('#name').value=''; $('#phone').value=''; $('#email').value='';
  $('#tags').value=''; $('#notes').value='';
  $('#createdAtLabel').textContent='—'; $('#updatedAtLabel').textContent='—';
  openSheet();
};
const openEdit = (id) => {
  const c = clients.find(x=>x.id===id); if(!c) return;
  $('#sheetTitle').textContent = 'Редактирование';
  $('#clientId').value = c.id;
  $('#name').value = c.name || '';
  $('#phone').value = c.phone || '';
  $('#email').value = c.email || '';
  $('#tags').value = (c.tags||[]).join(', ');
  $('#notes').value = c.notes || '';
  $('#createdAtLabel').textContent = fmt(c.createdAt);
  $('#updatedAtLabel').textContent = fmt(c.updatedAt||c.createdAt);
  openSheet();
};

$('#addBtn').onclick = openNew;
$('#cancelBtn').onclick = closeSheet;
$('#saveBtn').onclick = () => {
  const id = $('#clientId').value || uid();
  const name = $('#name').value.trim();
  if(!name) return toast('Введите имя');
  const phone = $('#phone').value.trim();
  const email = $('#email').value.trim();
  const tags = $('#tags').value.split(',').map(s=>s.trim()).filter(Boolean);
  const notes = $('#notes').value.trim();
  upsert({ id, name, phone, email, tags, notes });
  closeSheet(); toast('Сохранено');
};

$('#search').oninput = (e)=>{ q = e.target.value; render(); };
$$('.pill').forEach(p=> p.onclick = ()=>{
  $$('.pill').forEach(x=>x.classList.remove('active'));
  p.classList.add('active');
  filter = p.getAttribute('data-filter'); render();
});

$('#exportBtn').onclick = () => {
  const blob = new Blob([JSON.stringify(clients, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `clients-export-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
  a.click();
};
$('#importInput').onchange = async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text);
    if(!Array.isArray(data)) throw new Error('Неверный формат');
    const map = new Map(clients.map(c=>[c.id,c]));
    for(const c of data){ map.set(c.id || uid(), {...c, id: c.id || uid()}); }
    clients = Array.from(map.values());
    save(clients); render(); toast('Импортировано');
  }catch(err){
    alert('Ошибка импорта: ' + err.message);
  }finally{
    e.target.value = '';
  }
};

$('#clearBtn').onclick = ()=>{
  if(confirm('Очистить всех клиентов? Это действие нельзя отменить.')){
    clients = []; save(clients); render(); toast('Очищено');
  }
};

/* ====== Сервис-воркер из Blob (чтобы всё было в одном файле) ====== */
if('serviceWorker' in navigator){
  const swCode = `
    const CACHE = 'clients-app-v1';
    self.addEventListener('install', (e) => {
      e.waitUntil(caches.open(CACHE).then(c => c.addAll([self.registration.scope])));
      self.skipWaiting();
    });
    self.addEventListener('activate', (e) => {
      e.waitUntil(
        caches.keys().then(keys => Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k))))
      );
      self.clients.claim();
    });
    self.addEventListener('fetch', (e) => {
      const req = e.request;
      e.respondWith(
        caches.match(req).then(cached => cached || fetch(req).then(res => {
          if(req.method === 'GET' && new URL(req.url).origin === location.origin){
            const resClone = res.clone();
            caches.open(CACHE).then(c => c.put(req, resClone));
          }
          return res;
        }).catch(()=> cached))
      );
    });
  `;
  const blob = new Blob([swCode], {type: 'text/javascript'});
  const swUrl = URL.createObjectURL(blob);
  window.addEventListener('load', () => navigator.serviceWorker.register(swUrl).catch(()=>{}));
}

/* ====== Подсказка "Добавить на экран Домой" для iOS ====== */
(function(){
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if(isIOS && !isStandalone){
    setTimeout(()=>{ toast('Поделитесь → «На экран Домой» чтобы установить'); }, 800);
  }
})();

/* Стартовый рендер */
render();
</script>
</body>
</html>
