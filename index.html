<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Админ · Клиенты — Offline (с приватным паролем)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
:root{
  --bg:#0b0b0c; --card:#151517; --elev:#1b1b1e; --text:#fff; --muted:#9a9aa0;
  --tint:#0a84ff; --accent:#5ac8fa; --success:#30d158; --danger:#ff453a; --sep:rgba(255,255,255,.08);
  --radius:14px;
}
@media (prefers-color-scheme: light){
  :root{ --bg:#f6f7f9; --card:#fff; --elev:#f2f2f7; --text:#000; --muted:#6b6b70; --sep:rgba(0,0,0,.06); }
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"SF Pro Text","Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text)}
.safe{padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}
.container{max-width:760px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
.header{position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:10px;padding:12px 16px;background: color-mix(in oklab,var(--bg) 85%,transparent);border-bottom:1px solid var(--sep)}
.title{font-weight:800;font-size:18px;flex:1}
.btn{appearance:none;border:0;padding:9px 12px;border-radius:12px;background:var(--tint);color:#fff;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid color-mix(in oklab,var(--tint) 30%,var(--sep));color:var(--tint)}
.btn.small{padding:6px 8px;font-size:13px}
.main{flex:1;padding:14px;display:flex;flex-direction:column;gap:12px}
.card{background:var(--card);border:1px solid var(--sep);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.35)}
.pad{padding:14px}
.row{display:flex;gap:8px;align-items:center}
.label{font-size:13px;color:var(--muted)}
.input, textarea, select{
  width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--sep);background:var(--elev);color:var(--text);outline:none;font-size:15px;
}
.input:focus,textarea:focus{box-shadow:0 0 0 6px color-mix(in oklab,var(--tint) 10%, transparent)}
.grid-3{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:center}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.list{display:flex;flex-direction:column}
.item{display:grid;grid-template-columns: auto 1fr auto;gap:12px;align-items:center;padding:10px 12px;border-top:1px solid var(--sep)}
.item:first-child{border-top:none}
.name{font-weight:700}
.note{font-size:13px;color:var(--muted)}
.pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--sep);background:var(--elev)}
.checkbox{width:18px;height:18px}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.small{font-size:13px;color:var(--muted)}
.hidden{display:none !important}
.modal{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:60}
.modal .card{width:92%;max-width:600px}
.footer{padding:10px 16px;border-top:1px solid var(--sep);display:flex;justify-content:space-between;align-items:center}
.table-head{display:grid;grid-template-columns: auto 1fr 140px;gap:12px;padding:10px 12px;background: color-mix(in oklab,var(--bg) 94%,transparent);border-top-left-radius:12px;border-top-right-radius:12px}
.tag{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--sep);margin-right:6px;font-size:12px}
@media (max-width:720px){ .grid-3{grid-template-columns:1fr 1fr; } .table-head{grid-template-columns: auto 1fr; } .item{grid-template-columns:auto 1fr} }
</style>
</head>
<body class="safe">
<div class="container">
  <div class="header">
    <div class="title">Админ · Клиенты — Offline</div>
    <button id="btn-settings" class="btn ghost small">Настройки</button>
    <button id="btn-logout" class="btn ghost small hidden">Выйти</button>
  </div>

  <main class="main">
    <!-- LOGIN -->
    <section id="screen-login" class="card pad">
      <div style="text-align:center;margin-bottom:8px">
        <div style="font-size:20px;font-weight:800">Вход администратора</div>
        <div class="small" style="margin-top:4px">Доступ только для администратора</div>
      </div>
      <form id="login-form" style="display:flex;gap:8px;flex-direction:column">
        <label class="label">Пароль</label>
        <input id="password" class="input" type="password" placeholder="Введите пароль" autocomplete="current-password" required/>
        <div style="display:flex;gap:8px">
          <button class="btn" type="submit">Войти</button>
          <button id="btn-login-reset" type="button" class="btn ghost">Сброс данных</button>
        </div>
        <div class="small" id="login-note" style="display:none">Доступ защищён паролем.</div>
      </form>
    </section>

    <!-- APP -->
    <section id="screen-app" class="hidden" style="display:flex;flex-direction:column;gap:12px">
      <!-- Toolbar -->
      <div class="card pad">
        <div class="grid-3">
          <div>
            <div class="small">Всего</div>
            <div style="font-weight:900;font-size:24px" id="total-count">0</div>
          </div>
          <div>
            <div class="small">Этот месяц</div>
            <div style="font-weight:900;font-size:24px" id="month-count">0</div>
          </div>
          <div style="display:flex;justify-content:flex-end;gap:8px">
            <button id="btn-add" class="btn small">Добавить</button>
            <button id="btn-export-json" class="btn ghost small">Экспорт JSON</button>
            <button id="btn-export-csv" class="btn ghost small">Экспорт CSV</button>
            <button id="btn-import" class="btn ghost small">Импорт</button>
          </div>
        </div>
        <div style="height:8px"></div>
        <div class="grid-2">
          <input id="search" class="input" placeholder="Поиск по имени, телефону или заметке"/>
          <div style="display:flex;gap:8px">
            <select id="tag-filter" class="input">
              <option value="">Все метки</option>
            </select>
            <select id="sort-by" class="input">
              <option value="created_desc">Дата (новые)</option>
              <option value="created_asc">Дата (старые)</option>
              <option value="name_asc">Имя A→Z</option>
              <option value="name_desc">Имя Z→A</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Add / Edit Panel (toggle) -->
      <div id="panel-add" class="card pad hidden">
        <form id="add-form" style="display:flex;gap:8px;flex-direction:column">
          <div class="grid-2">
            <input id="name" class="input" placeholder="Имя клиента *" required/>
            <input id="phone" class="input" placeholder="Телефон"/>
          </div>
          <div>
            <textarea id="note" class="input" rows="3" placeholder="Заметка"></textarea>
          </div>
          <div>
            <input id="tags" class="input" placeholder="Метки (через запятую): VIP,новый"/>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn" type="submit">Сохранить</button>
            <button id="btn-cancel-add" type="button" class="btn ghost">Отмена</button>
          </div>
        </form>
      </div>

      <!-- List + Chart -->
      <div class="card pad">
        <div class="table-head">
          <div style="display:flex;align-items:center;gap:8px">
            <input id="select-all" type="checkbox" class="checkbox"/>
          </div>
          <div class="small">Клиенты</div>
          <div class="small" style="text-align:right">Дата / Действия</div>
        </div>

        <div id="list" class="list" style="max-height:360px;overflow:auto"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px">
          <div style="display:flex;gap:8px;align-items:center">
            <select id="bulk-action" class="input" style="width:160px">
              <option value="">Массовые действия</option>
              <option value="delete">Удалить выбранные</option>
              <option value="tag_add">Добавить метку</option>
              <option value="tag_remove">Удалить метку</option>
            </select>
            <input id="bulk-param" class="input" placeholder="Параметр (название метки)" style="width:180px"/>
            <button id="btn-bulk-apply" class="btn ghost small">Применить</button>
          </div>
          <div class="small muted">Выбрано: <span id="selected-count">0</span></div>
        </div>
      </div>

      <!-- Chart -->
      <div class="card pad">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small muted">Статистика по месяцам (последние 12 мес.)</div>
          <div class="small muted">Авто-логаут: <span id="idle-timeout-label">5 мин</span></div>
        </div>
        <canvas id="chart" width="800" height="260" style="width:100%;height:180px;margin-top:8px;border-radius:8px"></canvas>
      </div>

      <!-- Settings modal (hidden by default) -->
      <div id="settings-modal" class="modal hidden">
        <div class="card pad">
          <h3 style="margin:0 0 10px 0">Настройки</h3>
          <form id="settings-form" style="display:flex;flex-direction:column;gap:8px">
            <label class="label">Сменить пароль администратора</label>
            <input id="new-password" class="input" type="password" placeholder="Новый пароль (мин.6)"/>
            <div class="row">
              <label class="label">Таймаут авто-логаута (минут)</label>
              <input id="idle-timeout" class="input" type="number" min="1" max="240" value="5"/>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" type="submit">Сохранить</button>
              <button id="btn-clear-all" type="button" class="btn action-danger">Стереть все данные</button>
              <button id="btn-close-settings-modal" type="button" class="btn ghost">Закрыть</button>
            </div>
            <div class="small muted">Данные хранятся локально в браузере. Рекомендуется экспортировать резервную копию.</div>
          </form>
        </div>
      </div>

    </section>
  </main>

  <div class="footer small" style="padding:10px 16px;border-top:1px solid var(--sep);display:flex;justify-content:space-between">
    <div>Версия: offline · Без сервера</div>
    <div class="small muted">Откройте этот файл в браузере — всё работает локально</div>
  </div>
</div>

<!-- hidden file input -->
<input id="file-input" type="file" accept="application/json,text/csv" class="hidden"/>

<script>
/* ============================
   Авторизация по паролю:
   По умолчанию пароль установлен в переменной DEFAULT_PASSWORD ниже.
   ============================ */

/* ---------------- Константы ---------------- */
const KEYS = {
  CLIENTS: 'clients_offline_v2',
  ADMIN_SALT: 'admin_salt_v2',
  ADMIN_HASH: 'admin_hash_v2',
  SETTINGS: 'settings_v2'
};
// <- ТЫ МЕНЯЛ ПАРОЛЬ: здесь установлен твой приватный пароль по умолчанию
const DEFAULT_PASSWORD = 'nikitabelyy1337';

const app = {
  clients: [],
  session: false,
  settings: { idleTimeoutMin: 5 } // minutes
};

/* ---------------- WebCrypto helpers ---------------- */
const te = new TextEncoder();
async function sha256Base64(str){
  const buf = await crypto.subtle.digest('SHA-256', te.encode(str));
  return btoa(String.fromCharCode(...new Uint8Array(buf)));
}
function genSalt(len=16){ const b = new Uint8Array(len); crypto.getRandomValues(b); return btoa(String.fromCharCode(...b)); }
async function hashPassword(pwd, salt){ return await sha256Base64(salt + pwd); }

/* ---------------- Storage ---------------- */
function loadAll(){
  try{ app.clients = JSON.parse(localStorage.getItem(KEYS.CLIENTS) || '[]'); }catch{ app.clients = []; }
  try{ app.settings = JSON.parse(localStorage.getItem(KEYS.SETTINGS) || JSON.stringify(app.settings)); }catch{ }
}
function saveClients(){ localStorage.setItem(KEYS.CLIENTS, JSON.stringify(app.clients, null, 2)); updateUI(); }
function saveSettings(){ localStorage.setItem(KEYS.SETTINGS, JSON.stringify(app.settings)); }

/* ---------------- Admin init/check ---------------- */
async function ensureAdmin(){
  // Если в localStorage нет админ-хэша — создаём хэш от DEFAULT_PASSWORD
  let s = localStorage.getItem(KEYS.ADMIN_SALT), h = localStorage.getItem(KEYS.ADMIN_HASH);
  if(!s || !h){
    s = genSalt(16);
    const hh = await hashPassword(DEFAULT_PASSWORD, s);
    localStorage.setItem(KEYS.ADMIN_SALT, s);
    localStorage.setItem(KEYS.ADMIN_HASH, hh);
    // NOTE: мы не показываем пароль в интерфейсе — предполагается, что только ты его знаешь
  }
}
async function checkPassword(pwd){
  const salt = localStorage.getItem(KEYS.ADMIN_SALT);
  const real = localStorage.getItem(KEYS.ADMIN_HASH);
  if(!salt || !real) return false;
  const calc = await hashPassword(pwd, salt);
  return calc === real;
}
async function changePassword(newPwd){
  const s = genSalt(16);
  const h = await hashPassword(newPwd, s);
  localStorage.setItem(KEYS.ADMIN_SALT, s);
  localStorage.setItem(KEYS.ADMIN_HASH, h);
}

/* ---------------- UI helpers ---------------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function show(sel){ $(sel).classList.remove('hidden'); }
function hide(sel){ $(sel).classList.add('hidden'); }

/* ---------------- Idle / Auto-logout ---------------- */
let idleTimer = null;
function resetIdleTimer(){
  if(idleTimer) clearTimeout(idleTimer);
  const ms = (app.settings.idleTimeoutMin || 5) * 60 * 1000;
  idleTimer = setTimeout(()=>{ sessionStorage.removeItem('session_ok'); app.session=false; alert('Сессия истекла из-за простоя'); showLogin(); }, ms);
}
['mousemove','keydown','touchstart'].forEach(ev => window.addEventListener(ev, resetIdleTimer));

/* ---------------- Init ---------------- */
(async function init(){
  await ensureAdmin();
  loadAll();
  const sessionOk = sessionStorage.getItem('session_ok') === '1';
  if(sessionOk){ app.session = true; showApp(); } else { showLogin(); }
  populateTagFilter();
  updateUI();
  attachEvents();
  resetIdleTimer();
})();

/* ---------------- Show screens ---------------- */
function showLogin(){ hide('#screen-app'); show('#screen-login'); $('#btn-logout').classList.add('hidden'); }
function showApp(){ hide('#screen-login'); show('#screen-app'); $('#btn-logout').classList.remove('hidden'); }

/* ---------------- Events ---------------- */
function attachEvents(){
  // login
  $('#login-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const pwd = $('#password').value || '';
    const ok = await checkPassword(pwd);
    if(ok){
      sessionStorage.setItem('session_ok','1'); app.session = true; $('#password').value=''; showApp(); updateUI(); resetIdleTimer();
    } else alert('Неверный пароль');
  });
  $('#btn-login-reset').addEventListener('click', ()=>{
    if(confirm('Сбросить ВСЕ локальные данные и пароль? Это удалит клиентов и настройки.')){ localStorage.clear(); sessionStorage.clear(); alert('Данные удалены. Перезагрузите страницу.'); location.reload(); }
  });
  $('#btn-logout').addEventListener('click', ()=>{ sessionStorage.removeItem('session_ok'); app.session=false; showLogin(); });

  // add
  $('#btn-add').addEventListener('click', ()=>{ show('#panel-add'); $('#name').focus(); });
  $('#btn-cancel-add').addEventListener('click', ()=>{ hide('#panel-add'); $('#add-form').reset(); });
  $('#add-form').addEventListener('submit', (e)=>{
    e.preventDefault();
    const id = crypto.randomUUID(), name = $('#name').value.trim();
    if(!name){ alert('Введите имя'); return; }
    const client = {
      id, name, phone: $('#phone').value.trim(), note: $('#note').value.trim(),
      tags: parseTags($('#tags').value), createdAt: new Date().toISOString()
    };
    app.clients.push(client);
    saveClients();
    $('#add-form').reset(); hide('#panel-add');
  });

  // search/filter/sort
  $('#search').addEventListener('input', renderList);
  $('#tag-filter').addEventListener('change', renderList);
  $('#sort-by').addEventListener('change', renderList);

  // export/import
  $('#btn-export-json').addEventListener('click', exportJSON);
  $('#btn-export-csv').addEventListener('click', exportCSV);
  $('#btn-import').addEventListener('click', ()=> $('#file-input').click());
  $('#file-input').addEventListener('change', handleFileImport);

  // select all
  $('#select-all').addEventListener('change', (e)=>{
    const checked = e.target.checked;
    $$('.chk-select').forEach(c=>c.checked = checked);
    updateSelectedCount();
  });

  // bulk
  $('#btn-bulk-apply').addEventListener('click', ()=> applyBulkAction());

  // settings modal
  $('#btn-settings').addEventListener('click', ()=> { show('#settings-modal'); $('#idle-timeout').value = app.settings.idleTimeoutMin || 5; });
  $('#btn-close-settings-modal').addEventListener('click', ()=> hide('#settings-modal'));
  $('#settings-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const p = $('#new-password').value.trim();
    const t = parseInt($('#idle-timeout').value || 5);
    if(p.length>0){
      if(p.length<6){ alert('Пароль должен быть минимум 6 символов'); return; }
      await changePassword(p);
      $('#new-password').value='';
      alert('Пароль изменён');
    }
    app.settings.idleTimeoutMin = Math.max(1, Math.min(240, t));
    saveSettings();
    $('#idle-timeout-label').textContent = app.settings.idleTimeoutMin + ' мин';
    resetIdleTimer();
    hide('#settings-modal');
  });
  $('#btn-clear-all').addEventListener('click', ()=>{
    if(confirm('Стереть все данные клиентов и настройки?')){ localStorage.removeItem(KEYS.CLIENTS); localStorage.removeItem(KEYS.ADMIN_SALT); localStorage.removeItem(KEYS.ADMIN_HASH); localStorage.removeItem(KEYS.SETTINGS); app.clients=[]; saveClients(); alert('Готово. Перезагрузите страницу.'); location.reload(); }
  });

  // selection checkboxes update selected count
  document.addEventListener('change', (e)=>{ if(e.target && e.target.classList && e.target.classList.contains('chk-select')) updateSelectedCount(); });
}

/* ---------------- Utilities ---------------- */
function parseTags(s){
  if(!s) return [];
  return s.split(',').map(x=>x.trim()).filter(Boolean).map(x=>x.toLowerCase());
}
function uniqueTags(){
  const set = new Set();
  app.clients.forEach(c=> (c.tags||[]).forEach(t=> set.add(t)));
  return Array.from(set).sort();
}

/* ---------------- List rendering ---------------- */
function renderList(){
  const cont = $('#list'); cont.innerHTML = '';
  const q = ($('#search').value||'').toLowerCase().trim();
  const tagFilter = $('#tag-filter').value;
  const sortBy = $('#sort-by').value;
  let items = [...app.clients];

  if(tagFilter) items = items.filter(c => (c.tags||[]).includes(tagFilter));
  if(q) items = items.filter(c => (c.name||'').toLowerCase().includes(q) || (c.phone||'').toLowerCase().includes(q) || (c.note||'').toLowerCase().includes(q));

  if(sortBy === 'created_desc') items.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
  else if(sortBy === 'created_asc') items.sort((a,b)=> new Date(a.createdAt)-new Date(b.createdAt));
  else if(sortBy === 'name_asc') items.sort((a,b)=> a.name.localeCompare(b.name));
  else if(sortBy === 'name_desc') items.sort((a,b)=> b.name.localeCompare(a.name));

  if(items.length === 0){
    cont.innerHTML = '<div style="padding:14px" class="small muted">Клиенты не найдены</div>';
    updateSelectedCount(); drawChart();
    return;
  }

  items.forEach(c=>{
    const d = new Date(c.createdAt);
    const when = d.toLocaleString('ru-RU', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});
    const row = document.createElement('div'); row.className = 'item';
    const chk = document.createElement('input'); chk.type='checkbox'; chk.className='checkbox chk-select'; chk.dataset.id = c.id;
    const middle = document.createElement('div');
    middle.innerHTML = `<div class="name">${escapeHtml(c.name)} ${ (c.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('') }</div>
      <div class="note">${escapeHtml(c.phone||'')} ${c.phone && c.note?'· ':''}${escapeHtml(c.note||'')}</div>`;
    const right = document.createElement('div'); right.style.textAlign='right';
    right.innerHTML = `<div class="pill" title="${d.toLocaleString()}">${when}</div>
      <div style="height:8px"></div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <button class="btn ghost small" onclick="editClient('${c.id}')">Изменить</button>
        <button class="btn action-danger small" onclick="deleteClient('${c.id}')">Удалить</button>
      </div>`;
    row.appendChild(chk); row.appendChild(middle); row.appendChild(right);
    cont.appendChild(row);
  });
  updateSelectedCount(); drawChart();
  populateTagFilter();
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"'`=\/]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[ch])); }

/* ---------------- Selection / Bulk ---------------- */
function getSelectedIds(){
  return $$('.chk-select').filter(c=>c.checked).map(c=>c.dataset.id);
}
function updateSelectedCount(){ $('#selected-count').textContent = getSelectedIds().length; $('#select-all').checked = $$('.chk-select').length>0 && $$('.chk-select').every(c=>c.checked); }

function applyBulkAction(){
  const action = $('#bulk-action').value;
  const ids = getSelectedIds();
  if(!action){ alert('Выберите действие'); return; }
  if(ids.length===0){ alert('Нет выбранных клиентов'); return; }

  if(action === 'delete'){
    if(!confirm(`Удалить ${ids.length} выбранных клиентов?`)) return;
    app.clients = app.clients.filter(c=> !ids.includes(c.id));
    saveClients(); renderList(); return;
  }
  const param = ($('#bulk-param').value || '').trim().toLowerCase();
  if(!param){ alert('Укажите параметр (название метки)'); return; }
  if(action === 'tag_add'){
    app.clients.forEach(c=>{ if(ids.includes(c.id)){ c.tags = Array.from(new Set([...(c.tags||[]), param])); }});
    saveClients(); renderList(); return;
  }
  if(action === 'tag_remove'){
    app.clients.forEach(c=>{ if(ids.includes(c.id)){ c.tags = (c.tags||[]).filter(t=>t!==param); }});
    saveClients(); renderList(); return;
  }
}

/* ---------------- Edit / Delete single ---------------- */
window.deleteClient = function(id){
  if(!confirm('Удалить клиента?')) return;
  app.clients = app.clients.filter(c=>c.id !== id);
  saveClients(); renderList();
};
window.editClient = function(id){
  const c = app.clients.find(x=>x.id===id);
  if(!c){ alert('Клиент не найден'); return; }
  show('#panel-add');
  $('#name').value = c.name; $('#phone').value = c.phone||''; $('#note').value = c.note||''; $('#tags').value = (c.tags||[]).join(',');
  const handler = function(e){
    e.preventDefault();
    c.name = $('#name').value.trim() || c.name;
    c.phone = $('#phone').value.trim();
    c.note = $('#note').value.trim();
    c.tags = parseTags($('#tags').value);
    saveClients(); renderList();
    $('#add-form').removeEventListener('submit', handler);
    $('#add-form').reset(); hide('#panel-add');
  };
  $('#add-form').addEventListener('submit', handler);
};

/* ---------------- Export / Import ---------------- */
function exportJSON(){
  const blob = new Blob([JSON.stringify(app.clients, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `clients_backup_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'_')}.json`; document.body.appendChild(a); a.click(); a.remove();
}
function exportCSV(){
  if(app.clients.length===0){ alert('Нет данных для экспорта'); return; }
  const rows = [['id','name','phone','note','tags','createdAt']];
  app.clients.forEach(c=> rows.push([c.id, c.name, c.phone||'', c.note||'', (c.tags||[]).join(';'), c.createdAt]));
  const csv = rows.map(r => r.map(cell => `"${String(cell||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `clients_export_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'_')}.csv`; document.body.appendChild(a); a.click(); a.remove();
}

async function handleFileImport(e){
  const f = e.target.files && e.target.files[0]; if(!f) return;
  try{
    const text = await f.text();
    const isJson = f.type.includes('json') || text.trim().startsWith('[');
    if(isJson){
      const arr = JSON.parse(text);
      if(!Array.isArray(arr)) throw new Error('Неверный JSON формат');
      arr.forEach(x=>{ if(!x.id) x.id = crypto.randomUUID(); if(!x.createdAt) x.createdAt = new Date().toISOString(); if(!x.tags) x.tags = parseTags(x.tags?String(x.tags):''); });
      app.clients = arr;
      saveClients(); renderList(); alert('Импорт JSON выполнен');
    } else {
      const lines = text.split(/\r?\n/).filter(Boolean);
      const out = [];
      const headers = lines.shift().split(',').map(h=>h.replace(/^"|"$/g,'').trim());
      lines.forEach(line=>{
        const cols = line.match(/("([^"]|"")*"|[^,]+)/g) || [];
        const row = cols.map(c => c.replace(/^"|"$/g,'').replace(/""/g,'"'));
        const obj = {};
        headers.forEach((h,i)=> obj[h]=row[i]||'');
        out.push({ id: obj.id || crypto.randomUUID(), name: obj.name||'', phone: obj.phone||'', note: obj.note||'', tags: parseTags(obj.tags || ''), createdAt: obj.createdAt||new Date().toISOString() });
      });
      app.clients = out;
      saveClients(); renderList(); alert('Импорт CSV выполнен');
    }
  }catch(err){ alert('Ошибка импорта: '+err.message); }
  e.target.value = '';
}

/* ---------------- Chart ---------------- */
function drawChart(){
  const canvas = $('#chart'); if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const now = new Date();
  const months = []; const counts = [];
  for(let i=11;i>=0;i--){
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    months.push(d.toLocaleString('ru-RU',{month:'short',year:'2-digit'}));
    const keyYear = d.getFullYear(), keyMonth = d.getMonth();
    const cnt = app.clients.filter(c=>{ const dd=new Date(c.createdAt); return dd.getFullYear()===keyYear && dd.getMonth()===keyMonth; }).length;
    counts.push(cnt);
  }
  const DPR = window.devicePixelRatio || 1;
  const w = canvas.clientWidth, h = canvas.clientHeight;
  canvas.width = Math.floor(w * DPR); canvas.height = Math.floor(h * DPR); ctx.resetTransform && ctx.resetTransform();
  ctx.scale(DPR, DPR);
  ctx.clearRect(0,0,w,h);
  const padding = 32; const chartW = w - padding*2; const chartH = h - padding*2;
  const max = Math.max(1, ...counts);
  const barWidth = chartW / counts.length * 0.6;
  for(let i=0;i<counts.length;i++){
    const x = padding + i * (chartW / counts.length) + (chartW / counts.length - barWidth)/2;
    const barH = (counts[i]/max) * (chartH - 20);
    const y = padding + (chartH - barH);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--tint').trim() || '#0a84ff';
    roundRect(ctx, x, y, barWidth, barH, 6); ctx.fill();
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() || '#888';
    ctx.font = '11px system-ui'; ctx.textAlign='center';
    ctx.fillText(months[i].replace(/\s+/,' '), x + barWidth/2, padding + chartH + 14);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#000';
    ctx.font = '12px system-ui';
    ctx.fillText(String(counts[i]), x + barWidth/2, y - 6);
  }
}
function roundRect(ctx,x,y,w,h,r){ const rad=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rad,y); ctx.arcTo(x+w,y,x+w,y+h,rad); ctx.arcTo(x+w,y+h,x,y+h,rad); ctx.arcTo(x,y+h,x,y,rad); ctx.arcTo(x,y,x+w,y,rad); ctx.closePath(); }

/* ---------------- Tags / Filters ---------------- */
function populateTagFilter(){
  const sel = $('#tag-filter'); const current = sel.value;
  const tags = uniqueTags();
  sel.innerHTML = '<option value="">Все метки</option>' + tags.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
  if(tags.includes(current)) sel.value = current;
}

/* ---------------- UI update ---------------- */
function updateUI(){
  loadAll();
  $('#total-count').textContent = app.clients.length;
  const now = new Date();
  const mcount = app.clients.filter(c=>{ const d=new Date(c.createdAt); return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth(); }).length;
  $('#month-count').textContent = mcount;
  $('#idle-timeout-label').textContent = (app.settings.idleTimeoutMin || 5) + ' мин';
  renderList();
  drawChart();
}

/* ---------------- Helpers on resize ---------------- */
let resizeTimer; window.addEventListener('resize', ()=>{ clearTimeout(resizeTimer); resizeTimer = setTimeout(()=>{ drawChart(); },150); });

</script>
</body>
</html>
